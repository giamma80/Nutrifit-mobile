"""
Canonical GraphQL SDL.
Percorso canonico: backend/graphql/schema.graphql
Mirror obbligatorio: graphql/schema.graphql (root)

Non modificare solo uno dei due file.
Workflow aggiornamento:
    1. make -C backend schema-export   # genera runtime SDL
    2. make -C backend schema-sync     # copia e aggiorna hash
    3. make -C backend schema-check    # verifica drift (CI gate)

Modifiche manuali devono essere replicate nel mirror prima del commit.
Qualsiasi ricomparsa di backend/backend/graphql/schema.graphql è un errore e va rimossa.
"""
type ActivityEvent {
  userId: String!
  ts: String!
  steps: Int
  caloriesOut: Float
  hrAvg: Float
  source: ActivitySource!
}

enum ActivityLevelEnum {
  SEDENTARY
  LIGHT
  MODERATE
  ACTIVE
  VERY_ACTIVE
}

input ActivityMinuteInput {
  ts: String!
  steps: Int = 0
  caloriesOut: Float = null
  hrAvg: Float = null
  source: ActivitySource! = MANUAL
}

type ActivityMutations {
  """Sync batch minute activity events (idempotent)"""
  syncActivityEvents(input: [ActivityMinuteInput!]!, idempotencyKey: String = null, userId: String = null): IngestActivityResult!
}

type ActivityPeriodSummary {
  period: String!
  startDate: String!
  endDate: String!
  totalSteps: Int!
  totalCaloriesOut: Float!
  totalActiveMinutes: Int!
  avgHeartRate: Float
  eventCount: Int!

  """Has any activity data"""
  hasActivity: Boolean!

  """Avg steps per day in period"""
  avgDailySteps: Float!
}

type ActivityQueries {
  """Lista eventi attività con paginazione"""
  entries(limit: Int! = 100, after: String = null, before: String = null, userId: String = null): [ActivityEvent!]!

  """Lista delta sync health totals per giorno"""
  syncEntries(date: String!, userId: String = null, after: String = null, limit: Int! = 200): [HealthTotalsDelta!]!

  """Aggrega attività per range con raggruppamento"""
  aggregateRange(userId: String!, startDate: String!, endDate: String!, groupBy: GroupByPeriod! = DAY): ActivityRangeResult!
}

type ActivityRangeResult {
  periods: [ActivityPeriodSummary!]!
  total: ActivityPeriodSummary!
}

enum ActivitySource {
  APPLE_HEALTH
  GOOGLE_FIT
  MANUAL
}

type AggregateQueries {
  meal(mealId: String!, userId: String!): Meal
  mealHistory(userId: String!, startDate: DateTime = null, endDate: DateTime = null, mealType: String = null, limit: Int! = 20, offset: Int! = 0): MealHistoryResult!
  search(userId: String!, queryText: String!, limit: Int! = 20, offset: Int! = 0): MealSearchResult!
  dailySummary(userId: String!, date: DateTime!): DailySummary!
  summaryRange(userId: String!, startDate: DateTime!, endDate: DateTime!, groupBy: GroupByPeriod! = DAY): RangeSummaryResult!
}

input AnalyzeMealBarcodeInput {
  userId: String!
  barcode: String!
  quantityG: Float!
  mealType: MealType! = SNACK
  timestamp: DateTime = null
  idempotencyKey: String = null
}

input AnalyzeMealPhotoInput {
  userId: String!
  photoUrl: String!
  dishHint: String = null
  mealType: MealType! = LUNCH
  timestamp: DateTime = null
  idempotencyKey: String = null
}

input AnalyzeMealTextInput {
  userId: String!
  textDescription: String!
  mealType: MealType! = LUNCH
  timestamp: DateTime = null
  idempotencyKey: String = null
}

type AtomicQueries {
  recognizeFood(photoUrl: String = null, text: String = null, dishHint: String = null): FoodRecognitionResult!
  enrichNutrients(label: String!, quantityG: Float!): NutrientProfile
  searchFoodByBarcode(barcode: String!): BarcodeProduct
}

type BMRType {
  value: Float!
}

type BarcodeProduct {
  barcode: String!
  name: String!
  brand: String
  nutrients: NutrientProfile
  servingSizeG: Float
  imageUrl: String
}

type CacheStats {
  keys: Int!
  hits: Int!
  misses: Int!
}

type ConfirmAnalysisError {
  message: String!
  code: String!
}

input ConfirmAnalysisInput {
  mealId: String!
  userId: String!
  confirmedEntryIds: [String!]!
}

type ConfirmAnalysisSuccess {
  meal: Meal!
  confirmedCount: Int!
  rejectedCount: Int!
}

union ConfirmAnalysisSuccessConfirmAnalysisError = ConfirmAnalysisSuccess | ConfirmAnalysisError

input CreateProfileInput {
  userId: String!
  userData: UserDataInput!
  goal: GoalEnum!
  initialWeight: Float!
  initialDate: Date = null
}

type DailySummary {
  date: DateTime!
  totalCalories: Float!
  totalProtein: Float!
  totalCarbs: Float!
  totalFat: Float!
  totalFiber: Float!
  totalSugar: Float!
  totalSodium: Float!
  mealCount: Int!
  breakdownByType: String!
  hasMeals: Boolean!
}

"""Date (isoformat)"""
scalar Date

"""Date with time (isoformat)"""
scalar DateTime

type DeleteMealError {
  message: String!
  code: String!
}

input DeleteMealInput {
  mealId: String!
  userId: String!
}

type DeleteMealSuccess {
  mealId: String!
  message: String!
}

union DeleteMealSuccessDeleteMealError = DeleteMealSuccess | DeleteMealError

type FoodRecognitionResult {
  items: [RecognizedFood!]!
  averageConfidence: Float!
}

enum GoalEnum {
  CUT
  MAINTAIN
  BULK
}

enum GroupByPeriod {
  DAY
  WEEK
  MONTH
}

type HealthTotalsDelta {
  id: String!
  userId: String!
  date: String!
  timestamp: String!
  stepsDelta: Int!
  caloriesOutDelta: Float!
  stepsTotal: Int!
  caloriesOutTotal: Float!
  hrAvgSession: Float
}

input HealthTotalsInput {
  timestamp: String!
  date: String!
  steps: Int!
  caloriesOut: Float!
  hrAvgSession: Float = null
  userId: String = null
}

type IngestActivityResult {
  accepted: Int!
  duplicates: Int!
  rejected: [RejectedActivityEvent!]!
  idempotencyKeyUsed: String
}

type MacroSplitType {
  proteinG: Int!
  carbsG: Int!
  fatG: Int!
}

type Meal {
  id: String!
  userId: String!
  timestamp: DateTime!
  mealType: MealType!
  dishName: String!
  imageUrl: String
  source: String!
  confidence: Float!
  entries: [MealEntry!]!
  notes: String
  analysisId: String
  totalCalories: Int!
  totalProtein: Float!
  totalCarbs: Float!
  totalFat: Float!
  totalFiber: Float!
  totalSugar: Float!
  totalSodium: Float!
  createdAt: DateTime!
  updatedAt: DateTime
  entryCount: Int!
  averageConfidence: Float!
}

type MealAnalysisError {
  message: String!
  code: String!
}

type MealAnalysisSuccess {
  meal: Meal!
  analysisId: String
  processingTimeMs: Int
}

union MealAnalysisSuccessMealAnalysisError = MealAnalysisSuccess | MealAnalysisError

type MealEntry {
  id: String!
  name: String!
  displayName: String!
  quantityG: Float!
  calories: Int!
  protein: Float!
  carbs: Float!
  fat: Float!
  fiber: Float
  sugar: Float
  sodium: Float
  confidence: Float!
  barcode: String
}

type MealHistoryResult {
  meals: [Meal!]!
  totalCount: Int!
  hasMore: Boolean!
}

type MealMutations {
  analyzeMealPhoto(input: AnalyzeMealPhotoInput!): MealAnalysisSuccessMealAnalysisError!
  analyzeMealText(input: AnalyzeMealTextInput!): MealAnalysisSuccessMealAnalysisError!
  analyzeMealBarcode(input: AnalyzeMealBarcodeInput!): MealAnalysisSuccessMealAnalysisError!
  confirmMealAnalysis(input: ConfirmAnalysisInput!): ConfirmAnalysisSuccessConfirmAnalysisError!
  updateMeal(input: UpdateMealInput!): UpdateMealSuccessUpdateMealError!
  deleteMeal(input: DeleteMealInput!): DeleteMealSuccessDeleteMealError!
}

type MealSearchResult {
  meals: [Meal!]!
  totalCount: Int!
}

enum MealType {
  BREAKFAST
  LUNCH
  DINNER
  SNACK
}

type Mutation {
  """Meal domain mutations (CQRS commands)"""
  meals: MealMutations!

  """Activity domain mutations"""
  activity: ActivityMutations!

  """Nutritional profile mutations"""
  nutritionalProfile: NutritionalProfileMutations!

  """Sincronizza snapshot cumulativi attività"""
  syncHealthTotals(input: HealthTotalsInput!, idempotencyKey: String = null, userId: String = null): SyncHealthTotalsResult!
}

type NutrientProfile {
  calories: Float!
  protein: Float!
  carbs: Float!
  fat: Float!
  fiber: Float
  sugar: Float
  sodium: Float
  quantityG: Float!
}

type NutritionalProfileMutations {
  createNutritionalProfile(input: CreateProfileInput!): NutritionalProfileType!
  updateNutritionalProfile(input: UpdateProfileInput!): NutritionalProfileType!
  recordProgress(input: RecordProgressInput!): ProgressRecordType!
}

type NutritionalProfileQueries {
  nutritionalProfile(profileId: String = null, userId: String = null): NutritionalProfileType
  progressScore(userId: String!, startDate: Date!, endDate: Date!): ProgressStatisticsType
}

type NutritionalProfileType {
  profileId: String!
  userId: String!
  userData: UserDataType!
  goal: GoalEnum!
  bmr: BMRType!
  tdee: TDEEType!
  caloriesTarget: Float!
  macroSplit: MacroSplitType!
  progressHistory: [ProgressRecordType!]!
  createdAt: DateTime!
  updatedAt: DateTime!
}

type PeriodSummary {
  period: String!
  startDate: DateTime!
  endDate: DateTime!
  totalCalories: Float!
  totalProtein: Float!
  totalCarbs: Float!
  totalFat: Float!
  totalFiber: Float!
  totalSugar: Float!
  totalSodium: Float!
  mealCount: Int!
  breakdownByType: String!
  hasMeals: Boolean!
  avgDailyCalories: Float!
}

type ProgressRecordType {
  date: Date!
  weight: Float!
  consumedCalories: Float
  consumedProteinG: Float
  consumedCarbsG: Float
  consumedFatG: Float
  caloriesBurnedBmr: Float
  caloriesBurnedActive: Float
  notes: String
}

type ProgressStatisticsType {
  startDate: Date!
  endDate: Date!
  weightDelta: Float!
  avgDailyCalories: Float
  avgCaloriesBurned: Float
  avgDeficit: Float
  daysDeficitOnTrack: Int!
  daysMacrosOnTrack: Int!
  totalDays: Int!
  adherenceRate: Float!
}

type Query {
  serverTime: String!
  health: String!

  """Atomic utility queries for testing capabilities"""
  atomic: AtomicQueries!

  """Aggregate meal data queries"""
  meals: AggregateQueries!

  """Activity data queries"""
  activity: ActivityQueries!

  """Nutritional profile queries"""
  nutritionalProfile: NutritionalProfileQueries!

  """Statistiche cache prodotto"""
  cacheStats: CacheStats!
}

type RangeSummaryResult {
  periods: [PeriodSummary!]!
  total: PeriodSummary!
}

type RecognizedFood {
  label: String!
  displayName: String!
  quantityG: Float!
  confidence: Float!
}

input RecordProgressInput {
  profileId: String!
  date: Date!
  weight: Float!
  consumedCalories: Float = null
  consumedProteinG: Float = null
  consumedCarbsG: Float = null
  consumedFatG: Float = null
  caloriesBurnedBmr: Float = null
  caloriesBurnedActive: Float = null
  notes: String = null
}

type RejectedActivityEvent {
  index: Int!
  reason: String!
}

enum SexEnum {
  M
  F
}

type SyncHealthTotalsResult {
  accepted: Boolean!
  duplicate: Boolean!
  reset: Boolean!
  idempotencyKeyUsed: String
  idempotencyConflict: Boolean!
  delta: HealthTotalsDelta
}

type TDEEType {
  value: Float!
  activityLevel: ActivityLevelEnum!
}

type UpdateMealError {
  message: String!
  code: String!
}

input UpdateMealInput {
  mealId: String!
  userId: String!
  mealType: MealType = null
  timestamp: DateTime = null
  notes: String = null
}

type UpdateMealSuccess {
  meal: Meal!
}

union UpdateMealSuccessUpdateMealError = UpdateMealSuccess | UpdateMealError

input UpdateProfileInput {
  profileId: String!
  userData: UserDataInput = null
  goal: GoalEnum = null
}

input UserDataInput {
  weight: Float!
  height: Float!
  age: Int!
  sex: SexEnum!
  activityLevel: ActivityLevelEnum!
}

type UserDataType {
  weight: Float!
  height: Float!
  age: Int!
  sex: SexEnum!
  activityLevel: ActivityLevelEnum!
}
